<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        .debug-toggle {
            position: absolute;
            top: 20px;
            left: 30px;
            z-index: 20;
            display: flex;
            align-items: center;
        }
        .debug-toggle label {
            color: #ffe066;
            font-size: 1.1em;
            margin-left: 8px;
            cursor: pointer;
        }
        .debug-section { display: none; }
        .debug-section.visible { display: block; }
    </style>
    <link rel="preload" as="image" href="/static/load.gif">
    <link rel="preload" as="image" href="/static/load2.gif">
    <link rel="preload" as="image" href="/static/load3.gif">
    <link rel="preload" as="image" href="/static/libraryload.gif">
    <style>
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
        }
        #loading-overlay img {
            width: 180px;
            height: 180px;
            display: block;
            margin: 0 auto;
        }
        #loading-overlay > div {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #loading-overlay span {
            color: #ffe066;
            font-size: 1.3em;
            margin-top: 16px;
            display: block;
            text-align: center;
            transition: opacity .5s;
        }
    </style>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <meta charset="UTF-8">
    <title>Conjurr</title>
    <!-- Open Graph / Twitter Cards for rich previews -->
    <meta property="og:title" content="Conjurr Recommendations" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="{{ request.url }}" />
    <meta property="og:image" content="{{ url_for('static', filename='Conjurr.png', _external=True) }}" />
    <meta property="og:description" content="Personalized, history-based Plex recommendations with posters and categories." />
    <meta property="og:site_name" content="Conjurr" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Conjurr Recommendations" />
    <meta name="twitter:description" content="Personalized, history-based Plex recommendations with posters and categories." />
    <meta name="twitter:image" content="{{ url_for('static', filename='Conjurr.png', _external=True) }}" />
    <style>
        body {
            background: #111;
            color: #f0eaea;
            font-family: Arial, sans-serif;
        }
    .mode-toggle { display:inline-flex; border:1px solid #444; border-radius:8px; overflow:hidden; }
    .mode-toggle input { display:none; }
    .mode-toggle label { background:#222; color:#ccc; padding:6px 12px; cursor:pointer; user-select:none; font-size:0.85rem; }
    .mode-toggle input:checked + label { background:#ffe066; color:#222; font-weight:600; }
    .mode-toggle label + input + label { border-left:1px solid #444; }
    /* Tidy bullet lists inside table cells */
    td ul { margin: 0; padding-left: 1.2em; max-height: 280px; overflow: auto; }
    td li { margin: 0 0 3px 0; }
    td, th { word-break: break-word; }
    td { vertical-align: top; }
        .conjurr-banner {
            position: absolute;
            top: 20px;
            right: 30px;
            display: flex;
            align-items: center;
            z-index: 10;
        }
        .conjurr-banner img {
            width: 48px;
            height: 48px;
            margin-right: 10px;
        }
        .conjurr-banner span {
            font-size: 1.3em;
            font-weight: bold;
            color: #ffe066;
            text-shadow: 1px 1px 8px #000, 0 0 8px #ffe066;
            letter-spacing: 1px;
        }
        .conjurr-banner .version {
            display: block;
            font-size: 0.95em;
            font-weight: normal;
            color: #ddd08a;
            margin-top: 2px;
            text-shadow: 1px 1px 6px #000;
        }
    table { border-collapse: collapse; width: 85%; margin: 20px auto; background: #222; color: #f0eaea; }
    th, td { border: 1px solid #444; padding: 11px; text-align: left; }
        th { background: #333; color: #ffe066; }
    select, button, label { background: #222; color: #ffe066; border: 1px solid #444; }
    /* Enlarge user selector label and dropdown items */
    label[for="user_id"] { font-size: 1.2em; }
    #user_id { font-size: 1.15em; }
    #user_id option { font-size: 1.15em; }
        pre { background: #181818; color: #ffe066; }

        /* Prominent CTA button for recommendations */
        .primary-cta {
            background: #ffe066;
            color: #222;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.15em;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.35);
            transition: transform 0.05s ease, box-shadow 0.15s ease;
            min-width: 280px;
        }
        .primary-cta:hover:not(:disabled) { box-shadow: 0 4px 14px rgba(0,0,0,0.45); }
        .primary-cta:active:not(:disabled) { transform: translateY(1px); }
        .primary-cta:disabled { opacity: 0.55; cursor: not-allowed; }

        .user-row { margin-bottom: 8px; }
        .cta-row { margin-top: 10px; }

    /* Column max-widths: allow auto sizing but cap overly wide columns */
    /* Col order: 1 Type, 2 Available Recs, 3 Not In Library, 4 AI recommendations, 5 Top 3 Watched, 6 Most Watched, 7 Recent */
    table tr > th:nth-child(1),
    table tr > td:nth-child(1) { max-width: 90px; white-space: nowrap; }

    /* Available in Library */
    table tr > td:nth-child(2) { max-width: 28rem; }
    table tr > td:nth-child(2) ul { max-width: 28rem; }

    /* AI Recs Not In Library */
    table tr > td:nth-child(3) { max-width: 24rem; }
    table tr > td:nth-child(3) ul { max-width: 24rem; }

    /* AI Recommendations */
    table tr > td:nth-child(4) { max-width: 22rem; }
    table tr > td:nth-child(4) ul { max-width: 22rem; }

    /* Top 3 Watched */
    table tr > td:nth-child(5) { max-width: 16rem; }
    table tr > td:nth-child(5) ul { max-width: 16rem; }

    /* Most Watched (single item) */
    table tr > td:nth-child(6) { max-width: 14rem; }

    /* Recent (Last 10) */
    table tr > td:nth-child(7) { max-width: 24rem; }
    table tr > td:nth-child(7) ul { max-width: 24rem; }
    </style>
</head>
<body data-has-recs="{{ '1' if recs else '0' }}" data-user-mode="{{ '1' if user_mode else '0' }}">
    {% if is_localhost %}
    <form id="mode-toggle-form" action="/toggle_user_mode" method="post" style="position:absolute;top:18px;left:18px;z-index:30;background:#1a1a1a;border:1px solid #333;padding:6px 10px;border-radius:8px;display:flex;align-items:center;gap:8px;">
        <span style="color:#ddd08a;font-size:0.9em;">Mode:</span>
        <div class="mode-toggle">
            <input type="radio" name="value" id="um-off" value="0" {% if not user_mode %}checked{% endif %}/>
            <label for="um-off" title="Admin Mode">Admin</label>
            <input type="radio" name="value" id="um-on" value="1" {% if user_mode %}checked{% endif %}/>
            <label for="um-on" title="User Mode">User</label>
        </div>
        <button type="submit" style="margin-left:6px;padding:4px 8px;border-radius:6px;">Apply</button>
    </form>
    <script>
    (function(){
        var f=document.getElementById('mode-toggle-form');
        if(!f) return;
        f.addEventListener('submit', function(){
            // Show a quick loading hint
            try{
                var ov=document.getElementById('loading-overlay');
                if(ov){ ov.style.display='flex'; }
            }catch(e){}
        });
    })();
    </script>
    {% endif %}
    {% if not user_mode %}
    <a href="/settings" style="position:absolute;top:80px;left:24px;color:#ffe066;text-decoration:underline;font-size:1.1em;z-index:10;">⚙️ Settings</a>
    {% endif %}
    {% if not user_mode %}
    <div class="debug-toggle">
        <input type="checkbox" id="toggle-debug" style="width:18px;height:18px;" {% if not user_mode %}checked{% endif %}>
        <label for="toggle-debug">Show Debug Info</label>
    </div>
    {% endif %}
    <div id="loading-overlay" data-library-building="false" style="display: none;">
        <div class="loading-inner" style="background:#000;border:1px solid #222;padding:26px 30px;border-radius:18px;box-shadow:0 4px 28px rgba(0,0,0,0.7),0 0 12px rgba(0,0,0,0.6) inset;">
            <img id="loading-gif" src="/static/load.gif" alt="Loading...">
            <span id="loading-text" style="margin-top:14px;">Loading Conjurr's wisdom...</span>
        </div>
    </div>
    <div class="conjurr-banner">
        <img src="/static/load.gif" alt="Genie">
        <div>
            <span>Conjurr knows all</span>
            {% if version %}<span class="version">{{ version }}</span>{% endif %}
            {% if recs and recs.debug and recs.debug.gemini_model_used %}
                <span class="version" style="font-size:0.9em;color:#cfc088;">Model: {{ recs.debug.gemini_model_used }}</span>
            {% endif %}
        </div>
    </div>
    <h2 style="text-align:center">History Based Content Recommendations</h2>
    {% if not user_mode and user_config_status and user_config_status|length > 0 %}
    <div style="position:absolute;top:130px;left:18px;z-index:10;background:#222;padding:14px 18px;border-radius:10px;box-shadow:0 0 10px #0008;min-width:260px;">
        <div style="font-weight:bold;margin-bottom:6px;color:#ffe066;">Configuration Status</div>
        <ul style="list-style:none;margin:0;padding:0;font-size:0.85em;line-height:1.5;max-width:260px;">
            {% for it in user_config_status %}
            <li class="config-status-item{% if 'Library Filter:' in it.name %} config-status-libs{% endif %}" style="display:flex;align-items:flex-start;gap:6px;">
                <span style="width:18px;text-align:center;">{% if it.ok %}✅{% else %}❌{% endif %}</span>
                <span {% if not it.ok %}style="color:#ff8888;"{% endif %}>{{ it.name }}</span>
            </li>
            {% endfor %}
        </ul>
        <style>
            .config-status-item.config-status-libs { margin-top:4px; padding-top:4px; border-top:1px solid #333; }
        </style>
    </div>
    {% endif %}
    <form id="main-form" method="post" style="text-align:center; margin-bottom:20px;">
        {% if user_mode %}
            <div style="width:100%;margin:10px auto 12px auto;display:flex;flex-direction:column;align-items:center;">
                <label for="user_login">Enter Plex email or username:</label>
                <input name="user_login" id="user_login" value="{{ user_login_value or '' }}" type="text" placeholder="name@example.com or username" style="background:#222;color:#ffe066;border:1px solid #444;padding:8px 10px;border-radius:6px;min-width:280px;" />
            </div>
            {% if user_login_error %}
                <div style="color:#ff8888;margin-top:6px;">{{ user_login_error }}</div>
            {% endif %}
            <div style="margin-top:10px;display:flex;flex-direction:column;align-items:center;gap:10px;">
                <div style="display:flex;gap:18px;flex-wrap:wrap;justify-content:center;align-items:flex-end;">
                    <div>
                        <label style="font-size:0.9em;display:block;margin-bottom:4px;">Mode</label>
                        <div class="mode-toggle">
                            <input type="radio" name="mode" id="mode-history-user" value="history" {% if mode!='custom' %}checked{% endif %} />
                            <label for="mode-history-user">History</label>
                            <input type="radio" name="mode" id="mode-custom-user" value="custom" {% if mode=='custom' %}checked{% endif %} />
                            <label for="mode-custom-user">Custom</label>
                        </div>
                    </div>
                    <div id="decade-wrap" {% if mode!='custom' %}style="display:none;"{% endif %}>
                        <label style="font-size:0.9em;display:block;margin-bottom:4px;" for="decade">Decade</label>
                        <select name="decade" id="decade" style="padding:6px 8px;min-width:120px;">
                            <option value="">-- Any --</option>
                            <option value="1950" {% if decade_selected==1950 %}selected{% endif %}>1950s</option>
                            <option value="1960" {% if decade_selected==1960 %}selected{% endif %}>1960s</option>
                            <option value="1970" {% if decade_selected==1970 %}selected{% endif %}>1970s</option>
                            <option value="1980" {% if decade_selected==1980 %}selected{% endif %}>1980s</option>
                            <option value="1990" {% if decade_selected==1990 %}selected{% endif %}>1990s</option>
                            <option value="2000" {% if decade_selected==2000 %}selected{% endif %}>2000s</option>
                            <option value="2010" {% if decade_selected==2010 %}selected{% endif %}>2010s</option>
                            <option value="2020" {% if decade_selected==2020 %}selected{% endif %}>2020 - Now</option>
                        </select>
                    </div>
                    <div id="genre-wrap" {% if mode!='custom' %}style="display:none;"{% endif %}>
                        <label style="font-size:0.9em;display:block;margin-bottom:4px;" for="genre">Genre</label>
                        <select name="genre" id="genre" style="padding:6px 8px;min-width:140px;">
                            <option value="">-- Any --</option>
                            {% set gmap = {'action':'Action','drama':'Drama','comedy':'Comedy','scifi':'Sci-Fi','horror':'Horror','thriller':'Thriller','documentary':'Documentary','animation':'Animation','family':'Family','fantasy':'Fantasy','romance':'Romance','crime':'Crime','mystery':'Mystery','adventure':'Adventure','war':'War','western':'Western','musical':'Musical','biography':'Biography','history':'History','sports':'Sports'} %}
                            {% for k,v in gmap|dictsort(by='value') %}
                                <option value="{{ k }}" {% if genre_selected==k %}selected{% endif %}>{{ v }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div id="mood-wrap" {% if mode!='custom' %}style="display:none;"{% endif %}>
                        <label style="font-size:0.9em;display:block;margin-bottom:4px;" for="mood">Mood</label>
                        <select name="mood" id="mood" style="padding:6px 8px;min-width:140px;">
                            <option value="">-- Any --</option>
                            {% for k,v in moods|dictsort(by='value') %}
                                <option value="{{ k }}" {% if mood_selected==k %}selected{% endif %}>{{ v }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div id="custom-error-user" style="color:#ff8888;font-size:0.85em;margin-top:4px;">{% if debug_info and debug_info.error and (mode=='custom') and not recs %}{{ debug_info.error }}{% endif %}</div>
                <div class="cta-row" style="margin-top:2px;">
                    <button class="primary-cta" type="submit">Get Recommendations</button>
                </div>
            </div>
        {% else %}
            <div class="user-row">
                <label for="user_id">Select User:</label>
                <select name="user_id" id="user_id">
                {% if users and users|length > 0 %}
                    {% for user in users %}
                        <option value="{{ user.user_id }}" {% if selected_user and user.user_id == selected_user.user_id %}selected{% endif %}>{{ user.friendly_name or user.username }}</option>
                    {% endfor %}
                {% else %}
                    <option disabled selected>No users found</option>
                {% endif %}
                </select>
            </div>
            <div style="margin-top:14px;display:flex;flex-direction:column;align-items:center;gap:10px;">
                <div style="display:flex;gap:20px;flex-wrap:wrap;justify-content:center;align-items:flex-end;">
                    <div>
                        <label style="font-size:0.95em;display:block;margin-bottom:4px;">Mode</label>
                        <div class="mode-toggle">
                            <input type="radio" name="mode" id="mode-history-admin" value="history" {% if mode!='custom' %}checked{% endif %} />
                            <label for="mode-history-admin">History</label>
                            <input type="radio" name="mode" id="mode-custom-admin" value="custom" {% if mode=='custom' %}checked{% endif %} />
                            <label for="mode-custom-admin">Custom</label>
                        </div>
                    </div>
                    <div id="decade-wrap" {% if mode!='custom' %}style="display:none;"{% endif %}>
                        <label style="font-size:0.95em;display:block;margin-bottom:4px;" for="decade">Decade</label>
                        <select name="decade" id="decade" style="padding:6px 8px;min-width:120px;">
                            <option value="">-- Any --</option>
                            <option value="1950" {% if decade_selected==1950 %}selected{% endif %}>1950s</option>
                            <option value="1960" {% if decade_selected==1960 %}selected{% endif %}>1960s</option>
                            <option value="1970" {% if decade_selected==1970 %}selected{% endif %}>1970s</option>
                            <option value="1980" {% if decade_selected==1980 %}selected{% endif %}>1980s</option>
                            <option value="1990" {% if decade_selected==1990 %}selected{% endif %}>1990s</option>
                            <option value="2000" {% if decade_selected==2000 %}selected{% endif %}>2000s</option>
                            <option value="2010" {% if decade_selected==2010 %}selected{% endif %}>2010s</option>
                            <option value="2020" {% if decade_selected==2020 %}selected{% endif %}>2020 - Now</option>
                        </select>
                    </div>
                    <div id="genre-wrap" {% if mode!='custom' %}style="display:none;"{% endif %}>
                        <label style="font-size:0.95em;display:block;margin-bottom:4px;" for="genre">Genre</label>
                        <select name="genre" id="genre" style="padding:6px 8px;min-width:140px;">
                            <option value="">-- Any --</option>
                            {% set gmap = {'action':'Action','drama':'Drama','comedy':'Comedy','scifi':'Sci-Fi','horror':'Horror','thriller':'Thriller','documentary':'Documentary','animation':'Animation','family':'Family','fantasy':'Fantasy','romance':'Romance','crime':'Crime','mystery':'Mystery','adventure':'Adventure','war':'War','western':'Western','musical':'Musical','biography':'Biography','history':'History','sports':'Sports'} %}
                            {% for k,v in gmap|dictsort(by='value') %}
                                <option value="{{ k }}" {% if genre_selected==k %}selected{% endif %}>{{ v }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div id="mood-wrap" {% if mode!='custom' %}style="display:none;"{% endif %}>
                        <label style="font-size:0.95em;display:block;margin-bottom:4px;" for="mood">Mood</label>
                        <select name="mood" id="mood" style="padding:6px 8px;min-width:140px;">
                            <option value="">-- Any --</option>
                            {% for k,v in moods|dictsort(by='value') %}
                                <option value="{{ k }}" {% if mood_selected==k %}selected{% endif %}>{{ v }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div id="custom-error-admin" style="color:#ff8888;font-size:0.85em;margin-top:4px;">{% if debug_info and debug_info.error and (mode=='custom') and not recs %}{{ debug_info.error }}{% endif %}</div>
                <div class="cta-row" style="margin-top:6px;">
                    <button class="primary-cta" type="submit" {% if not users or users|length == 0 %}disabled{% endif %}>Get Recommendations</button>
                </div>
            </div>
            <br>
            {% if not users or users|length == 0 %}
                <div style="color: #ff8888; margin-top: 8px;">No users returned from Tautulli. Check Settings or Tautulli connectivity.</div>
            {% endif %}
        {% endif %}
    </form>
    {% if selection_desc %}
    <div style="text-align:center;margin:20px auto 10px auto;padding:0 20px;">
        <div style="color:#ffe066;font-size:1.4em;font-weight:bold;text-shadow:1px 1px 4px #000;">
            <span style="color:#ddd08a;">{{ selection_desc }}</span>
        </div>
    </div>
    {% endif %}
    {% if recs %}
    <div style="width:100%;margin:10px auto 20px auto;display:flex;flex-direction:column;align-items:center;">
        <style>
            .poster-row { display:inline-flex; flex-wrap:wrap; gap:12px; align-items:flex-start; justify-content:center; }
            .poster-card { width:140px; text-align:center; }
            /* Overlay metadata on hover (desktop only) */
            .poster-overlay-wrap { position:relative; width:100%; aspect-ratio:2/3; overflow:hidden; border-radius:10px; }
            .poster-overlay-wrap img { width:100%; height:100%; object-fit:cover; display:block; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.4); }
            .poster-overlay { position:absolute; inset:0; background:rgba(0,0,0,0.82); color:#ddd; border-radius:10px; opacity:0; transition:opacity .22s ease; display:flex; flex-direction:column; padding:8px 9px 10px; box-sizing:border-box; border:1px solid #333; pointer-events:none; }
            .poster-overlay:hover, .poster-overlay-wrap:hover .poster-overlay { opacity:1; }
            .pb-title { font-size:0.9rem; font-weight:600; color:#ffe066; line-height:1.2; margin-bottom:4px; text-align:left; }
            .pb-meta { font-size:0.78rem; color:#bbb; display:flex; justify-content:flex-start; gap:8px; flex-wrap:wrap; margin-bottom:6px; }
            .pb-overview { font-size:0.75rem; color:#ddd; line-height:1.18; overflow:hidden; flex:1 1 auto; text-align:left; max-height:7.2em; display:-webkit-box; -webkit-line-clamp:6; -webkit-box-orient:vertical; line-clamp:6; text-overflow:ellipsis; }
            .pb-rating { color:#ffd24d; }
            .poster-title { margin-top:6px; font-size:0.9em; color:#ddd; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
            .poster-year { font-size:0.75em; color:#aaa; margin-top:2px; }
            .poster-section-title { color:#ffe066; margin: 10px 0 6px 0; font-weight:bold; text-align:center; font-size:1.35em; }
            .poster-box { display:inline-block; background:#1a1a1a; border:1px solid #333; border-radius:12px; padding:12px 14px 16px; box-shadow:0 2px 10px rgba(0,0,0,0.35); margin:14px 0; max-width:100%; }
            .poster-box .poster-section-title { margin: 4px 0 10px 0; }
            .user-mode-username { color:#ffe066; font-size:2rem; font-weight:700; text-align:center; padding:10px 0 6px; margin:6px 0 4px; text-shadow: 1px 1px 6px #000; }
            /* AI categories ticker */
            .ticker { position: relative; overflow: hidden; width: 100%; }
            .ticker__content { display: inline-flex; align-items: center; gap: 22px; white-space: nowrap; padding: 6px 0; animation: ticker-scroll 35s linear infinite; }
            .ticker__item { color: #ddd; font-size: 0.95em; background: #222; border: 1px solid #333; border-radius: 999px; padding: 6px 12px; }
            .ticker:hover .ticker__content { animation-play-state: paused; }
            @keyframes ticker-scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        </style>
        {% if not tmdb_enabled %}
            <div style="text-align:center;color:#ec1e1e;margin:10px 0 6px 0;">** Add TMDb API key in Settings for content posters **</div>
        {% endif %}
        {% if recs and recs.show_posters and recs.show_posters[0].href %}
            <div class="muted-note">Click a poster to open the title in Overseerr. Recommendations are (probably) unwatched for your account.</div>
        {% endif %}
        {% if user_mode and selected_user %}
            {% set user_name = (selected_user.friendly_name or selected_user.username) if selected_user else None %}
            {% if user_name %}
                <div class="user-mode-username">Recommendations for {{ user_name }}</div>
            {% endif %}
        {% endif %}
        <style>
            .poster-sections-row { display:flex; gap:14px; flex-wrap:wrap; justify-content:center; align-items:flex-start; }
            .poster-box.alt { background:#1a1a00; border-color:#6b6b1f; }
            .poster-box.alt .poster-section-title { color:#ffe066; }
            .muted-note { color:#ddd08a; font-size:0.9em; text-align:center; margin-top:4px; }
        </style>
        {# Movies row (separate) #}
        {% if recs.movie_posters or recs.movie_posters_unavailable %}
        <div class="poster-sections-row">
            {% if recs.movie_posters %}
            <div class="poster-box">
                <div class="poster-section-title">Movies on Plex</div>
                <div class="poster-row" aria-label="Recommended movies posters">
                    {% for p in recs.movie_posters[:9] %}
                    <div class="poster-card" title="{{ p.title }}">
                        <div class="poster-overlay-wrap">
                            {% if p.href %}<a href="{{ p.href }}" target="_blank" rel="noopener noreferrer" style="display:block;width:100%;height:100%;position:absolute;inset:0;z-index:5;">&nbsp;</a>{% endif %}
                            <img src="{{ p.url }}" alt="{{ p.title }} poster">
                            <div class="poster-overlay">
                                <div class="pb-title">{{ p.title }}</div>
                                <div class="pb-meta">
                                    {% if p.year %}<span>{{ p.year }}</span>{% endif %}
                                    {% if p.runtime %}<span>{{ p.runtime }}</span>{% endif %}
                                    {% if p.vote %}<span class="pb-rating">★ {{ p.vote }}</span>{% endif %}
                                </div>
                                {% if p.overview %}<div class="pb-overview">{{ p.overview }}</div>{% else %}<div class="pb-overview" style="opacity:.45;">No synopsis.</div>{% endif %}
                            </div>
                        </div>
                        <div class="poster-title">{{ p.title }}</div>
                        {% if recs.ai_movie_years and recs.ai_movie_years.get(p.title) %}<div class="poster-year">{{ recs.ai_movie_years.get(p.title) }}</div>{% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% if recs.movie_posters_unavailable %}
            <div class="poster-box alt">
                <div class="poster-section-title">Movies not on Plex... yet</div>
                <div class="poster-row" aria-label="Unavailable movies posters">
                    {% for p in recs.movie_posters_unavailable[:9] %}
                    <div class="poster-card" title="{{ p.title }}">
                        <div class="poster-overlay-wrap">
                            {% if p.href %}<a href="{{ p.href }}" target="_blank" rel="noopener noreferrer" style="display:block;width:100%;height:100%;position:absolute;inset:0;z-index:5;">&nbsp;</a>{% endif %}
                            <img src="{{ p.url }}" alt="{{ p.title }} poster">
                            <div class="poster-overlay">
                                <div class="pb-title">{{ p.title }}</div>
                                <div class="pb-meta">
                                    {% if p.year %}<span>{{ p.year }}</span>{% endif %}
                                    {% if p.runtime %}<span>{{ p.runtime }}</span>{% endif %}
                                    {% if p.vote %}<span class="pb-rating">★ {{ p.vote }}</span>{% endif %}
                                </div>
                                {% if p.overview %}<div class="pb-overview">{{ p.overview }}</div>{% else %}<div class="pb-overview" style="opacity:.45;">No synopsis.</div>{% endif %}
                            </div>
                        </div>
                        <div class="poster-title">{{ p.title }}</div>
                        {% if recs.ai_movie_years and recs.ai_movie_years.get(p.title) %}<div class="poster-year">{{ recs.ai_movie_years.get(p.title) }}</div>{% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
        {# Shows row (separate) #}
        {% if recs.show_posters or recs.show_posters_unavailable %}
        <div class="poster-sections-row">
            {% if recs.show_posters %}
            <div class="poster-box">
                <div class="poster-section-title">Shows on Plex</div>
                <div class="poster-row" aria-label="Recommended shows posters">
                    {% for p in recs.show_posters[:9] %}
                    <div class="poster-card" title="{{ p.title }}">
                        <div class="poster-overlay-wrap">
                            {% if p.href %}<a href="{{ p.href }}" target="_blank" rel="noopener noreferrer" style="display:block;width:100%;height:100%;position:absolute;inset:0;z-index:5;">&nbsp;</a>{% endif %}
                            <img src="{{ p.url }}" alt="{{ p.title }} poster">
                            <div class="poster-overlay">
                                <div class="pb-title">{{ p.title }}</div>
                                <div class="pb-meta">
                                    {% if p.year %}<span>{{ p.year }}</span>{% endif %}
                                    {% if p.runtime %}<span>{{ p.runtime }}</span>{% endif %}
                                    {% if p.vote %}<span class="pb-rating">★ {{ p.vote }}</span>{% endif %}
                                </div>
                                {% if p.overview %}<div class="pb-overview">{{ p.overview }}</div>{% else %}<div class="pb-overview" style="opacity:.45;">No synopsis.</div>{% endif %}
                            </div>
                        </div>
                        <div class="poster-title">{{ p.title }}</div>
                        {% if recs.ai_show_years and recs.ai_show_years.get(p.title) %}<div class="poster-year">{{ recs.ai_show_years.get(p.title) }}</div>{% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% if recs.show_posters_unavailable %}
            <div class="poster-box alt">
                <div class="poster-section-title">Shows not on Plex... yet</div>
                <div class="poster-row" aria-label="Unavailable shows posters">
                    {% for p in recs.show_posters_unavailable[:9] %}
                    <div class="poster-card" title="{{ p.title }}">
                        <div class="poster-overlay-wrap">
                            {% if p.href %}<a href="{{ p.href }}" target="_blank" rel="noopener noreferrer" style="display:block;width:100%;height:100%;position:absolute;inset:0;z-index:5;">&nbsp;</a>{% endif %}
                            <img src="{{ p.url }}" alt="{{ p.title }} poster">
                            <div class="poster-overlay">
                                <div class="pb-title">{{ p.title }}</div>
                                <div class="pb-meta">
                                    {% if p.year %}<span>{{ p.year }}</span>{% endif %}
                                    {% if p.runtime %}<span>{{ p.runtime }}</span>{% endif %}
                                    {% if p.vote %}<span class="pb-rating">★ {{ p.vote }}</span>{% endif %}
                                </div>
                                {% if p.overview %}<div class="pb-overview">{{ p.overview }}</div>{% else %}<div class="pb-overview" style="opacity:.45;">No synopsis.</div>{% endif %}
                            </div>
                        </div>
                        <div class="poster-title">{{ p.title }}</div>
                        {% if recs.ai_show_years and recs.ai_show_years.get(p.title) %}<div class="poster-year">{{ recs.ai_show_years.get(p.title) }}</div>{% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
    {# Show AI Categories only in history mode (not custom) #}
    {% if recs.ai_categories and mode != 'custom' %}
            <div class="poster-box" style="display:block; width:85%; max-width:980px;">
                {% set user_name = (selected_user.friendly_name or selected_user.username) if selected_user else None %}
                <div class="poster-section-title">{{ (user_name ~ "'s") if user_name else 'AI' }} Categories</div>
                <div class="ticker" aria-label="AI Categories ticker">
                    <div class="ticker__content">
                        {% set cats = category_links if category_links else [] %}
                        {% if cats and overseerr_url %}
                            {% for it in cats %}
                                <a class="ticker__item" style="text-decoration:none;" href="{{ it.url }}" target="_blank" rel="noopener noreferrer">{{ it.label }}</a>
                            {% endfor %}
                            {% for it in cats %}
                                <a class="ticker__item" style="text-decoration:none;" href="{{ it.url }}" target="_blank" rel="noopener noreferrer">{{ it.label }}</a>
                            {% endfor %}
                        {% else %}
                            {% for it in recs.ai_categories %}
                                <span class="ticker__item">{{ it }}</span>
                            {% endfor %}
                            {% for it in recs.ai_categories %}
                                <span class="ticker__item">{{ it }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
    {% endif %}
    {% if recs %}
    <br>
    <br>
    {% if user_mode %}
        <div style="text-align:center;margin-bottom:8px;">
            <a href="#" id="toggle-details" style="color:#ffe066;text-decoration:underline;font-size:0.95em;">show table details</a>
        </div>
        <div id="details-container" style="display:none;">
            <table>
    {% else %}
            <table>
    {% endif %}
        <tr>
            <th>Type</th>
            <th>Recommendations (Available, Unwatched)</th>
            <th>AI Recs Not In Library (Unwatched)</th>
            <th>AI Recommendations</th>
            <th>Top 3 Watched</th>
            <th>Most Watched</th>
            <th>Recently Watched</th>
        </tr>
        <tr>
            <td>Movies</td>
            <td>
                {% if recs.movies %}
                <ul>
                    {% for it in recs.movies[:9] %}<li>{{ it }}</li>{% endfor %}
                </ul>
                {% else %}-{% endif %}
            </td>
            <td>
                {% if recs.ai_movies_unavailable %}
                <ul>
                    {% for it in recs.ai_movies_unavailable %}<li>{{ it }}</li>{% endfor %}
                </ul>
                {% else %}-{% endif %}
            </td>
            <td>
                {% set movie_top = recs.ai_movies_titles if recs.ai_movies_titles else recs.ai_movies %}
                {% if movie_top %}
                <ul>
                    {% for it in movie_top %}<li>{{ it }}</li>{% endfor %}
                </ul>
                {% else %}-{% endif %}
            </td>
            <td>
                {% if recs.top_movies %}
                <ul>
                    {% for it in recs.top_movies %}<li>{{ it }}</li>{% endfor %}
                </ul>
                {% else %}-{% endif %}
            </td>
            <td>{% if recs.top_movies %}{{ recs.top_movies[0] }}{% else %}-{% endif %}</td>
            <td>
                {% if recs.debug and recs.debug.recent_movies %}
                <ul>
                    {% for it in recs.debug.recent_movies %}<li>{{ it }}</li>{% endfor %}
                </ul>
                {% else %}-{% endif %}
            </td>
        </tr>
        <tr>
            <td>Shows</td>
            <td>
                {% if recs.shows %}
                <ul>
                    {% for it in recs.shows[:9] %}<li>{{ it }}</li>{% endfor %}
                </ul>
                {% else %}-{% endif %}
            </td>
            <td>
                {% if recs.ai_shows_unavailable %}
                <ul>
                    {% for it in recs.ai_shows_unavailable %}<li>{{ it }}</li>{% endfor %}
                </ul>
                {% else %}-{% endif %}
            </td>
            <td>
                {% set show_top = recs.ai_shows_titles if recs.ai_shows_titles else recs.ai_shows %}
                {% if show_top %}
                <ul>
                    {% for it in show_top %}<li>{{ it }}</li>{% endfor %}
                </ul>
                {% else %}-{% endif %}
            </td>
            <td>
                {% if recs.top_shows %}
                <ul>
                    {% for it in recs.top_shows %}<li>{{ it }}</li>{% endfor %}
                </ul>
                {% else %}-{% endif %}
            </td>
            <td>{% if recs.top_shows %}{{ recs.top_shows[0] }}{% else %}-{% endif %}</td>
            <td>
                {% if recs.debug and recs.debug.recent_shows %}
                <ul>
                    {% for it in recs.debug.recent_shows %}<li>{{ it }}</li>{% endfor %}
                </ul>
                {% else %}-{% endif %}
            </td>
        </tr>
    </table>
    {% if user_mode %}
        </div>
    {% endif %}
    {% endif %}
    {% if recs and not user_mode %}
    <div id="timing-section" style="width:60%;margin:20px auto;">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px;">
            <div style="margin:10px 0;min-width:220px;">
                <b>Gemini:</b>
                <div>
                    <div>SDK: {{ recs.debug.genai_sdk if recs and recs.debug else 'N/A' }}</div>
                    <div>Model: {{ recs.debug.gemini_model_used if recs and recs.debug and recs.debug.gemini_model_used else 'N/A' }}</div>
                    {% if recs and recs.debug and recs.debug.gemini_usage %}
                        {% set u = recs.debug.gemini_usage %}
                        <div style="font-size:0.95em;color:#bbb;">
                            prompt tokens: {{ u.prompt_token_count if u.prompt_token_count is not none else 'N/A' }},
                            candidates tokens: {{ u.candidates_token_count if u.candidates_token_count is not none else 'N/A' }},
                            total: {{ u.total_token_count if u.total_token_count is not none else 'N/A' }}
                        </div>
                    {% else %}
                        <div style="font-size:0.95em;color:#bbb;">usage: N/A</div>
                    {% endif %}
                    {% if recs and recs.debug and recs.debug.gemini_usage_today %}
                        {% set d = recs.debug.gemini_usage_today %}
                        <div style="font-size:0.95em;color:#bbb;">today: {{ d.calls }} calls, {{ d.total_tokens }} tokens</div>
                    {% endif %}
                    {% if recs and recs.debug and recs.debug.gemini_daily_quota %}
                        <div style="font-size:0.95em;color:#bbb;">quota: {{ recs.debug.gemini_daily_quota }} calls; remaining: {{ recs.debug.gemini_daily_remaining }}</div>
                    {% endif %}
                </div>
            </div>
            <div style="margin:10px 0;">
                <b>Timing (seconds):</b>
                <ul>
                    <li>User history fetch: {{ recs.debug.timing.user_history|default('N/A')|round(2) if recs and recs.debug and recs.debug.timing and recs.debug.timing.user_history is not none else 'N/A' }}</li>
                    <li>Top watched calc: {{ recs.debug.timing.top_watched|default('N/A')|round(2) if recs and recs.debug and recs.debug.timing and recs.debug.timing.top_watched is not none else 'N/A' }}</li>
                    <li>Library fetch: {% if recs and recs.debug and recs.debug.timing and recs.debug.timing.library_fetch is not none and recs.debug.timing.library_fetch is number %}{{ recs.debug.timing.library_fetch|round(2) }}{% elif recs and recs.debug and recs.debug.timing and recs.debug.timing.library_fetch is not none %}{{ recs.debug.timing.library_fetch }}{% else %}N/A{% endif %}</li>
                    <li>Unwatched filter: (deprecated)</li>
                    <li>Gemini call: {% if recs and recs.debug and recs.debug.timing and recs.debug.timing.gemini is not none and recs.debug.timing.gemini is number %}{{ recs.debug.timing.gemini|round(2) }}{% else %}{{ recs.debug.timing.gemini if recs and recs.debug and recs.debug.timing and recs.debug.timing.gemini is not none else 'N/A' }}{% endif %}</li>
                    <li>AI parse: {{ recs.debug.timing.ai_parse|default('N/A')|round(2) if recs and recs.debug and recs.debug.timing and recs.debug.timing.ai_parse is not none else 'N/A' }}</li>
                    <li>Fuzzy match: {{ recs.debug.timing.fuzzy_match|default('N/A')|round(2) if recs and recs.debug and recs.debug.timing and recs.debug.timing.fuzzy_match is not none else 'N/A' }}</li>
                    <li>Posters fetch: {{ recs.debug.timing.posters|default('N/A')|round(2) if recs and recs.debug and recs.debug.timing and recs.debug.timing.posters is not none else 'N/A' }}</li>
                </ul>
            </div>
            <div style="margin:10px 0;text-align:right;min-width:220px;">
                <b style="color:#ffe066;">Data Source:</b>
                <div>
                    {% if use_tautulli_db %}
                        Using Tautulli DB
                        {% if tautulli_db_path %}
                        <div style="font-size:0.9em;color:#bbb;max-width:260px;word-break:break-all;">{{ tautulli_db_path }}</div>
                        {% endif %}
                    {% else %}
                        Using Tautulli API
                    {% endif %}
                </div>
                {% if recs and recs.debug and recs.debug.poster_sources %}
                <div style="margin-top:8px; font-size:0.95em; color:#bbb;">
                    Posters: {{ recs.debug.poster_sources.summary }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
    {% if not user_mode %}
    <div class="debug-section {% if not user_mode %}visible{% endif %}" id="debug-section" style="width:50%;margin:20px auto;">
        {% if recs %}
            {% if recs.debug.library_shows_full %}
                <div><b>Library Shows (Full List):</b>
                    <pre style="white-space:pre-wrap;max-height:400px;overflow:auto;">{{ recs.debug.library_shows_full | tojson(indent=2) }}</pre>
                </div>
            {% endif %}
            {% if recs.debug.library_movies_full %}
                <div><b>Library Movies (Full List):</b>
                    <pre style="white-space:pre-wrap;max-height:400px;overflow:auto;">{{ recs.debug.library_movies_full | tojson(indent=2) }}</pre>
                </div>
            {% endif %}
            {% if recs.debug.fuzzy_show_matches %}
                <div><b>Fuzzy Show Matches:</b>
                    <pre style="white-space:pre-wrap;max-height:200px;overflow:auto;">{{ recs.debug.fuzzy_show_matches | tojson(indent=2) }}</pre>
                </div>
            {% endif %}
            {% if recs.debug.fuzzy_movie_matches %}
                <div><b>Fuzzy Movie Matches:</b>
                    <pre style="white-space:pre-wrap;max-height:200px;overflow:auto;">{{ recs.debug.fuzzy_movie_matches | tojson(indent=2) }}</pre>
                </div>
            {% endif %}
        {% endif %}
        <h3>Debug Info</h3>
        {% if debug_info.error %}
            <div style="color:red;">{{ debug_info.error }}</div>
        {% endif %}
        {% if debug_info.note %}
            <div style="color:orange;">{{ debug_info.note }}</div>
        {% endif %}
        {% if recs %}
            <div>History count: {{ recs.history_count }}</div>
            <div>Unwatched shows available: {{ recs.debug.unwatched_shows_count }}</div>
            <div>Unwatched movies available: {{ recs.debug.unwatched_movies_count }}</div>
            <div>All shows in library: {{ recs.debug.all_shows_count }}</div>
            <div>All movies in library: {{ recs.debug.all_movies_count }}</div>
            <div>Watched set count: {{ recs.debug.watched_set_count }}</div>
            <div>Gemini AI Shows: {{ recs.debug.gemini_ai_shows|join(', ') }}</div>
            <div>Gemini AI Movies: {{ recs.debug.gemini_ai_movies|join(', ') }}</div>
            <div>Gemini AI Shows Available in Library: {{ recs.debug.gemini_ai_shows_available|join(', ') }}</div>
            <div>Gemini AI Movies Available in Library: {{ recs.debug.gemini_ai_movies_available|join(', ') }}</div>
            <div>Show section IDs: {{ recs.debug.show_section_ids }}</div>
            <div>Movie section IDs: {{ recs.debug.movie_section_ids }}</div>
            <div>Show items found: {{ recs.debug.show_items_found }}</div>
            <div>Movie items found: {{ recs.debug.movie_items_found }}</div>
            <div>Raw libraries: <pre style="white-space:pre-wrap;max-height:200px;overflow:auto;">{{ recs.debug.raw_libraries }}</pre></div>
            {% if recs.debug.get_libraries_error %}
                <div style="color:red;">get_libraries error: {{ recs.debug.get_libraries_error }}</div>
            {% endif %}
            {% if recs.debug.get_library_media_info_errors %}
                <div style="color:red;">get_library_media_info errors: {{ recs.debug.get_library_media_info_errors }}</div>
            {% endif %}
            <div style="margin-top:10px;">
                <b>Gemini (Google AI Studio) Debug:</b>
                <div><b>Prompt:</b> <pre style="white-space:pre-wrap;max-height:100px;overflow:auto;">{{ recs.debug.gemini_prompt }}</pre></div>
                <div><b>Raw Response:</b> <pre style="white-space:pre-wrap;max-height:100px;overflow:auto;">{{ recs.debug.gemini_raw_response }}</pre></div>
                <div><b>Parsed JSON:</b> <pre style="white-space:pre-wrap;max-height:100px;overflow:auto;">{{ recs.debug.gemini_parsed_json }}</pre></div>
                <div><b>Recent shows (last 10):</b> {{ recs.debug.recent_shows|join(', ') }}</div>
                <div><b>Recent movies (last 10):</b> {{ recs.debug.recent_movies|join(', ') }}</div>
                {% if recs.debug.gemini_error %}
                    <div style="color:red;">Gemini error: {{ recs.debug.gemini_error }}</div>
                {% endif %}
            </div>
            {% if recs.debug.overseerr_availability %}
            <div style="margin-top:15px;">
                <b>Overseerr Availability Debug:</b>
                <div><b>Base URL:</b> {{ recs.debug.overseerr_availability.base_url or 'Not configured' }}</div>
                <div><b>Shows Checked:</b> {{ recs.debug.overseerr_availability.shows_checked or 0 }}</div>
                <div><b>Shows Available:</b> {{ recs.debug.overseerr_availability.shows_available or 0 }}</div>
                <div><b>Movies Checked:</b> {{ recs.debug.overseerr_availability.movies_checked or 0 }}</div>
                <div><b>Movies Available:</b> {{ recs.debug.overseerr_availability.movies_available or 0 }}</div>
                <div><b>PlexUrl Hits (Shows):</b> {{ recs.debug.overseerr_availability.plexurl_hits_shows or 0 }}</div>
                <div><b>PlexUrl Hits (Movies):</b> {{ recs.debug.overseerr_availability.plexurl_hits_movies or 0 }}</div>
                <div><b>Duration:</b> {{ recs.debug.overseerr_availability.duration_total or 0 }}s total</div>
                {% if recs.debug.overseerr_availability.errors %}
                <div style="color:red;"><b>Errors:</b> 
                    <ul>{% for error in recs.debug.overseerr_availability.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                </div>
                {% endif %}
                {% if recs.debug.overseerr_availability.sample_calls %}
                <div><b>Sample API Calls:</b>
                    <pre style="white-space:pre-wrap;max-height:300px;overflow:auto;font-size:0.9em;">{{ recs.debug.overseerr_availability.sample_calls | tojson(indent=2) }}</pre>
                </div>
                {% endif %}
            </div>
            {% endif %}
        {% endif %}
    </div>
    {% endif %}
</body>
<script>
    // Whether the library is currently being built (from server-side state via data attribute)
    var overlayEl = document.getElementById('loading-overlay');
    var libraryBuilding = !!(overlayEl && overlayEl.getAttribute('data-library-building') === 'true');
    // Debug toggle logic (only present when not in user mode)
    document.addEventListener('DOMContentLoaded', function() {
        var debugToggle = document.getElementById('toggle-debug');
        var debugSection = document.getElementById('debug-section');
        if (debugToggle && debugSection) {
            debugToggle.addEventListener('change', function() {
                if (debugToggle.checked) {
                    debugSection.classList.add('visible');
                } else {
                    debugSection.classList.remove('visible');
                }
            });
            // Leave initial state as rendered by server (visible when not in user mode)
        }
    });
    // Randomly select a loading gif
    function pickLoadingGif(forceLibrary) {
        var img = document.getElementById('loading-gif');
        if (!img) return;
        if (forceLibrary || libraryBuilding) {
            img.src = '/static/libraryload.gif';
            return;
        }
        var gifs = ['/static/load.gif', '/static/load2.gif', '/static/load3.gif'];
        var idx = Math.floor(Math.random() * gifs.length);
        img.src = gifs[idx];
    }

    // Removed click-to-flip; hover now controls flip so clicks follow Overseerr links

    var _zPhraseCycler = null;
    function pickLoadingPhrase(initial) {
        if (libraryBuilding) return; // keep library message during build
        var phrases = [
            "Consulting Conjurr's crystal ball...",
            "Checking out blockbuster shelves...",
            "Summoning Conjurr's ancient wisdom...",
            "Peeking behind the velvet curtain...",
            "Looking for hidden gems...",
            "Polishing the magic lamp lol...",
            "Reading fortunes in your watch history...",
            "Asking the oracle (please hold)...",
            "Shuffling fate's deck...",
            "Conjurr and chill?",
            "Whoops, not that movie...",
            "Uhhh... I mean, how about this one?",
            "Don't yell at the developer",
            "Fine tuning suggestions...",
            "Checking spark plugs...",
            "Reticulating Splines...",
            "Optimizing the flux capacitor...",
            "Spooling up turbines..."
        ];
        var el = document.getElementById('loading-text');
        if (!el) return;
        if(initial){
            el.textContent = phrases[Math.floor(Math.random()*phrases.length)];
        }
        // Clear any existing cycler
        if(_zPhraseCycler){ clearInterval(_zPhraseCycler); _zPhraseCycler=null; }
        _zPhraseCycler = setInterval(function(){
            if(!overlayEl || overlayEl.style.display==='none'){ clearInterval(_zPhraseCycler); _zPhraseCycler=null; return; }
            var next = phrases[Math.floor(Math.random()*phrases.length)];
            // Avoid repeating same text consecutively
            if(next === el.textContent){ next = phrases[(phrases.indexOf(next)+1)%phrases.length]; }
            el.style.opacity = 0;
            setTimeout(function(){ el.textContent = next; el.style.opacity = 1; }, 500);
        }, 4000);
    }

    // Hide loading overlay when page is fully loaded (for initial load)
    window.addEventListener('load', function() {
        setTimeout(function() {
            var overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.style.display = 'none';
        }, 200); // slight delay for smoothness
    });

    // Show loading overlay on form submit and pick an appropriate gif
    document.addEventListener('DOMContentLoaded', function() {
        // Only randomize on initial load if we're NOT in library-building mode
        if (!libraryBuilding) {
            pickLoadingGif(false);
            pickLoadingPhrase(true);
        }
    var form = document.getElementById('main-form');
        if (form) {
            form.addEventListener('submit', function(e) {
                // Client-side custom mode validation
                var modeVal = (document.querySelector('input[name="mode"]:checked')||{}).value;
                if(modeVal==='custom'){
                    var decadeSel=document.getElementById('decade');
                    var genreSel=document.getElementById('genre');
                    var moodSel=document.getElementById('mood');
                    var noDecade = !decadeSel || !decadeSel.value;
                    var noGenre = !genreSel || !genreSel.value;
                    var noMood = !moodSel || !moodSel.value;
                    if(noDecade && noGenre && noMood){
                        e.preventDefault();
                        var errElUser = document.getElementById('custom-error-user');
                        var errElAdmin = document.getElementById('custom-error-admin');
                        if(errElUser) errElUser.textContent = 'Select a decade, genre, or mood (or any combination) for Custom mode.';
                        if(errElAdmin) errElAdmin.textContent = 'Select a decade, genre, or mood (or any combination) for Custom mode.';
                        return false;
                    }
                }
                // During library build, force the library-specific gif; otherwise randomize
                pickLoadingGif(libraryBuilding);
                pickLoadingPhrase(true);
                var overlay = document.getElementById('loading-overlay');
                if (overlay) overlay.style.display = 'flex';
            });
        }
        // Table details toggle for user mode
        var toggle = document.getElementById('toggle-details');
        var details = document.getElementById('details-container');
        if (toggle && details) {
            toggle.addEventListener('click', function(e) {
                e.preventDefault();
                var isHidden = details.style.display === 'none' || details.style.display === '';
                details.style.display = isHidden ? 'block' : 'none';
                toggle.textContent = isHidden ? 'hide table details' : 'show table details';
            });
        }
    });
</script>
<script>
function toggleCustomFields(){
    var customRadio=document.querySelector('input[name="mode"][value="custom"]');
    var show = customRadio && customRadio.checked;
    ['decade-wrap','genre-wrap','mood-wrap'].forEach(function(id){ var el=document.getElementById(id); if(el){ el.style.display = show? 'block':'none'; }});
}
function handleMoodSelection(){
    // Only manage these fields when Custom mode is active
    var customRadio = document.querySelector('input[name="mode"][value="custom"]');
    var isCustom = !!(customRadio && customRadio.checked);
    if(!isCustom){
        ['decade-wrap','genre-wrap'].forEach(function(id){
            var el=document.getElementById(id);
            if(el){ el.style.display='none'; }
        });
        return;
    }
    var moodSel = document.getElementById('mood');
    if(!moodSel) return;
    var hasMood = moodSel.value && moodSel.value !== '';
    if(hasMood) {
        // Hide decade and genre when mood is selected, per Option A requirement
        ['decade-wrap','genre-wrap'].forEach(function(id){ 
            var el=document.getElementById(id); 
            if(el){ el.style.display = 'none'; }
        });
        // Set decade and genre to "Any" (empty value) when mood is selected
        var decadeSel=document.getElementById('decade'); if(decadeSel) decadeSel.value='';
        var genreSel=document.getElementById('genre'); if(genreSel) genreSel.value='';
    } else {
        // Show decade and genre when no mood is selected
        ['decade-wrap','genre-wrap'].forEach(function(id){ 
            var el=document.getElementById(id); 
            if(el){ el.style.display = 'block'; }
        });
    }
}
document.addEventListener('DOMContentLoaded',function(){
    toggleCustomFields();
    handleMoodSelection();
    var radios=document.querySelectorAll('input[name="mode"]');
    radios.forEach(function(r){ r.addEventListener('change', toggleCustomFields); });
    var moodSel=document.getElementById('mood');
    if(moodSel){ moodSel.addEventListener('change', handleMoodSelection); }
    // If we have recommendations shown and are not in custom mode, ensure filters remain hidden
    try{
        var hasRecs = document.body.getAttribute('data-has-recs')==='1';
        var customRadio = document.querySelector('input[name="mode"][value="custom"]');
        var isCustom = !!(customRadio && customRadio.checked);
        if(hasRecs && !isCustom){
            ['decade-wrap','genre-wrap','mood-wrap'].forEach(function(id){ var el=document.getElementById(id); if(el){ el.style.display='none'; }});
        }
    }catch(e){}
});
</script>
<script>
// Cookie helpers
function zSetCookie(name,value,days){ try { var d=new Date(); d.setTime(d.getTime()+ (days*24*60*60*1000)); document.cookie=name+"="+encodeURIComponent(value)+";expires="+d.toUTCString()+";path=/"; } catch(e){} }
function zGetCookie(name){ try { var n=name+"="; var ca=document.cookie.split(';'); for(var i=0;i<ca.length;i++){ var c=ca[i].trim(); if(c.indexOf(n)==0) return decodeURIComponent(c.substring(n.length,c.length)); } }catch(e){} return ""; }

function zPopulateFromCookies(){
    var hasRecs = document.body.getAttribute('data-has-recs')==='1';
    if(hasRecs) return; // only populate on clean GET
    var userMode = document.body.getAttribute('data-user-mode')==='1';
    if(userMode){
        var u = zGetCookie('z_user_login');
        if(u){ var input=document.getElementById('user_login'); if(input && !input.value) input.value=u; }
    }
    var m = zGetCookie('z_mode');
    if(m){ var radio = document.querySelector('input[name="mode"][value="'+m+'"]'); if(radio){ radio.checked=true; }}
    var d = zGetCookie('z_decade');
    if(d){ var decadeSel=document.getElementById('decade'); if(decadeSel){ decadeSel.value=d; }}
    var g = zGetCookie('z_genre');
    if(g){ var genreSel=document.getElementById('genre'); if(genreSel){ genreSel.value=g; }}
    var mood = zGetCookie('z_mood');
    if(mood){ var moodSel=document.getElementById('mood'); if(moodSel){ moodSel.value=mood; }}
    toggleCustomFields();
}

function zStoreOnSubmit(){
    var form = document.getElementById('main-form');
    if(!form) return;
    form.addEventListener('submit', function(){
        var user=document.getElementById('user_login'); if(user) zSetCookie('z_user_login', user.value||'', 30);
        var modeVal = (document.querySelector('input[name="mode"]:checked')||{}).value || 'history'; zSetCookie('z_mode', modeVal, 30);
        var decadeSel=document.getElementById('decade'); if(decadeSel) zSetCookie('z_decade', decadeSel.value||'', 30);
        var genreSel=document.getElementById('genre'); if(genreSel) zSetCookie('z_genre', genreSel.value||'', 30);
        var moodSel=document.getElementById('mood'); if(moodSel) zSetCookie('z_mood', moodSel.value||'', 30);
    });
}

document.addEventListener('DOMContentLoaded', function(){
    zPopulateFromCookies();
    zStoreOnSubmit();
    // If this is a POST page with recs, convert history state to GET to avoid resubmit prompt
    if(document.body.getAttribute('data-has-recs')==='1'){
        try { window.history.replaceState({}, document.title, window.location.pathname); } catch(e){}
    }
});
</script>
