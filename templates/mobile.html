<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Zoltarr Mobile</title>
    <!-- Open Graph / Twitter Cards for rich previews -->
    <meta property="og:title" content="Zoltarr Recommendations" />
    <meta property="og:type" content="we        function handleMoodSelectionMobile(){
            var moodSel = document.getElementById('mood');
            if(!moodSel) return;
            var hasMood = moodSel.value && moodSel.value !== '';
            if(hasMood) {
                // Hide decade and genre when mood is selected, per Option A requirement
                ['decade-wrap','genre-wrap'].forEach(function(id){ 
                    var el=document.getElementById(id); 
                    if(el){ el.style.display = 'none'; }
                });
                // Set decade and genre to "Any" (empty value) when mood is selected
                var decadeSel=document.getElementById('decade'); if(decadeSel) decadeSel.value='';
                var genreSel=document.getElementById('genre'); if(genreSel) genreSel.value='';
            } else {
                // Show decade and genre when no mood is selected
                ['decade-wrap','genre-wrap'].forEach(function(id){ 
                    var el=document.getElementById(id); 
                    if(el){ el.style.display = 'block'; }
                });
            }
        }<meta property="og:url" content="{{ request.url }}" />
    <meta property="og:image" content="{{ url_for('static', filename='ZoltarrBig.png', _external=True) }}" />
    <meta property="og:description" content="Personalized, history-based Plex recommendations with posters and categories." />
    <meta property="og:site_name" content="Zoltarr" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Zoltarr Recommendations" />
    <meta name="twitter:description" content="Personalized, history-based Plex recommendations with posters and categories." />
    <meta name="twitter:image" content="{{ url_for('static', filename='ZoltarrBig.png', _external=True) }}" />
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <style>
        :root {
            --bg: #111;
            --panel: #1a1a1a;
            --text: #f0eaea;
            --muted: #bbb;
            --accent: #ffe066;
            --border: #333;
        }
        html, body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
        .wrap { max-width: 100%; }
        .topbar { display:flex; align-items:center; justify-content:center; gap:10px; padding:12px 10px 4px; }
        .topbar img { width:36px; height:36px; }
        .title { font-weight:700; color:var(--accent); text-shadow: 0 0 8px #000; }
        .version { display:block; font-size:0.85em; color:#ddd08a; text-align:center; margin-top:2px; }

        /* Form */
        form { display:flex; flex-direction:column; align-items:center; gap:10px; padding: 6px 12px 10px; }
        label { color:var(--accent); font-size:1rem; }
        input[type="text"] { width: 92vw; max-width: 560px; background:#222; color:var(--accent); border:1px solid var(--border); padding:12px 14px; border-radius:8px; font-size:1rem; }
        .primary-cta { width: 92vw; max-width: 560px; background:var(--accent); color:#222; border:none; padding:14px; border-radius:10px; font-weight:700; font-size:1.05rem; box-shadow:0 2px 10px rgba(0,0,0,0.35); }
        .err { color:#ff8a8a; font-size:0.95rem; }

        /* Loading overlay */
        #loading-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:9999; display:none; align-items:center; justify-content:center; }
        #loading-overlay img { width:120px; height:120px; display:block; }
        #loading-overlay span { display:block; color:var(--accent); margin-top:10px; text-align:center; }

        /* Posters */
        .section { display:block; margin: 10px auto; padding: 10px 10px 14px; background: var(--panel); border:1px solid var(--border); border-radius:12px; width: 94vw; max-width: 680px; box-shadow:0 2px 10px rgba(0,0,0,0.35); }
        .section h3 { color:var(--accent); margin: 2px 0 10px; text-align:center; font-size:1.1rem; }
        .username { color:var(--accent); text-align:center; font-weight:700; font-size:1.25rem; margin: 2px 0 6px; }
        .grid { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; }
    .card { width:28vw; max-width:110px; text-align:center; }
    .card img { width:100%; height:auto; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.4); display:block; }
    .card .t { margin-top:6px; font-size:0.9rem; color:#ddd; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .card .y { font-size:0.7rem; color:#aaa; margin-top:2px; }
    .section.alt { background:#1a1a00; border-color:#6b6b1f; }
    .note { color:#ddd08a; font-size:0.9rem; text-align:center; margin-top:4px; }

        /* Categories ticker */
        .ticker { position:relative; overflow:hidden; width:100%; }
        .ticker__content { display:inline-flex; align-items:center; gap:14px; white-space:nowrap; padding:6px 0; animation: ticker 35s linear infinite; }
        .ticker__item { color:#ddd; font-size:0.9rem; background:#222; border:1px solid var(--border); border-radius:999px; padding:6px 12px; }
        .ticker:hover .ticker__content { animation-play-state: paused; }
        @keyframes ticker { from { transform: translateX(0); } to { transform: translateX(-50%); } }

        /* Table details (collapsible) */
        .toggle { text-align:center; margin: 6px 0 10px; }
        .toggle a { color:var(--accent); text-decoration:underline; font-size:0.95rem; }
        .tbl-wrap { display:none; overflow-x:auto; }
        table { border-collapse:collapse; width: 94vw; max-width: 680px; margin: 0 auto; background:#222; color:var(--text); font-size: 0.95rem; table-layout: fixed; }
        th, td { border:1px solid #444; padding:8px; text-align:left; vertical-align:top; word-wrap: break-word; }
        th { background:#333; color:var(--accent); position:sticky; top:0; }
        td ul { margin:0; padding-left: 1.1em; max-height: 220px; overflow:auto; }

        /* Banner spacing */
        .banner-space { height: 4px; }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="loading-inner" style="background:#000;border:1px solid #222;padding:22px 26px;border-radius:18px;box-shadow:0 4px 26px rgba(0,0,0,0.7),0 0 12px rgba(0,0,0,0.55) inset;display:flex;flex-direction:column;align-items:center;">
            <img id="loading-gif" src="/static/load.gif" alt="Loading..." onerror="this.onerror=null;this.src='/static/load.gif';" />
            <span id="loading-text" style="margin-top:12px;">Loading Zoltarr's wisdom...</span>
        </div>
    </div>

    <div class="wrap">
        <div class="topbar">
            <img src="/static/load.gif" alt="Genie" />
            <div>
                <div class="title">Zoltarr knows all</div>
                {% if version %}<div class="version">{{ version }}</div>{% endif %}
                {% if recs and recs.debug and recs.debug.gemini_model_used %}
                    <div class="version" style="font-size:0.85em; color:#cfc088;">Model: {{ recs.debug.gemini_model_used }}</div>
                {% endif %}
            </div>
        </div>
        <div class="banner-space"></div>

        <h2 style="text-align:center; font-size:1.1rem; margin: 4px 0 6px;">History Based Content Recommendations</h2>

        <form method="post">
            <label for="user_login">Enter Plex email or username:</label>
            <input name="user_login" id="user_login" value="{{ user_login_value or '' }}" type="text" placeholder="name@example.com or username" />
            {% if user_login_error %}
                <div class="err">{{ user_login_error }}</div>
            {% endif %}
            <div style="display:flex;flex-wrap:wrap;gap:14px;justify-content:center;margin-top:4px;">
                <style>
                    .mode-toggle { display:inline-flex; border:1px solid var(--border); border-radius:8px; overflow:hidden; }
                    .mode-toggle input { display:none; }
                    .mode-toggle label { background:#222; color:#ccc; padding:6px 10px; cursor:pointer; font-size:0.8rem; user-select:none; }
                    .mode-toggle input:checked + label { background:var(--accent); color:#222; font-weight:600; }
                    .mode-toggle label + input + label { border-left:1px solid var(--border); }
                </style>
                <div style="display:flex;flex-direction:column;align-items:center;gap:2px;">
                    <label style="font-size:0.8rem;display:block;">Mode</label>
                    <div class="mode-toggle" id="mode-toggle-mobile">
                        <input type="radio" name="mode" id="m-history" value="history" {% if mode!='custom' %}checked{% endif %} />
                        <label for="m-history">History</label>
                        <input type="radio" name="mode" id="m-custom" value="custom" {% if mode=='custom' %}checked{% endif %} />
                        <label for="m-custom">Custom</label>
                    </div>
                </div>
                <div id="decade-wrap" data-block="decade" style="min-width:120px;display:none;">
                    <label style="font-size:0.8rem;display:block;margin-bottom:2px;" for="decade">Decade</label>
                    <select name="decade" id="decade" style="width:100%;background:#222;color:var(--accent);border:1px solid var(--border);padding:6px 8px;border-radius:6px;">
                        <option value="">-- Any --</option>
                        <option value="1950" {% if decade_selected==1950 %}selected{% endif %}>1950s</option>
                        <option value="1960" {% if decade_selected==1960 %}selected{% endif %}>1960s</option>
                        <option value="1970" {% if decade_selected==1970 %}selected{% endif %}>1970s</option>
                        <option value="1980" {% if decade_selected==1980 %}selected{% endif %}>1980s</option>
                        <option value="1990" {% if decade_selected==1990 %}selected{% endif %}>1990s</option>
                        <option value="2000" {% if decade_selected==2000 %}selected{% endif %}>2000s</option>
                        <option value="2010" {% if decade_selected==2010 %}selected{% endif %}>2010s</option>
                        <option value="2020" {% if decade_selected==2020 %}selected{% endif %}>2020 - Now</option>
                    </select>
                </div>
                <div id="genre-wrap" data-block="genre" style="min-width:140px;display:none;">
                    <label style="font-size:0.8rem;display:block;margin-bottom:2px;" for="genre">Genre</label>
                    <select name="genre" id="genre" style="width:100%;background:#222;color:var(--accent);border:1px solid var(--border);padding:6px 8px;border-radius:6px;">
                        <option value="">-- Any --</option>
                        {% set gmap = {'action':'Action','drama':'Drama','comedy':'Comedy','scifi':'Sci-Fi','horror':'Horror','thriller':'Thriller','documentary':'Documentary','animation':'Animation','family':'Family','fantasy':'Fantasy','romance':'Romance','crime':'Crime','mystery':'Mystery','adventure':'Adventure','war':'War','western':'Western','musical':'Musical','biography':'Biography','history':'History','sports':'Sports'} %}
                        {% for k,v in gmap|dictsort(by='value') %}
                            <option value="{{ k }}" {% if genre_selected==k %}selected{% endif %}>{{ v }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div id="mood-wrap" data-block="mood" style="min-width:140px;display:none;">
                    <label style="font-size:0.8rem;display:block;margin-bottom:2px;" for="mood">Mood</label>
                    <select name="mood" id="mood" style="width:100%;background:#222;color:var(--accent);border:1px solid var(--border);padding:6px 8px;border-radius:6px;">
                        <option value="">-- Any --</option>
                        {% for k,v in moods|dictsort(by='value') %}
                            <option value="{{ k }}" {% if mood_selected==k %}selected{% endif %}>{{ v }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div id="custom-error-mobile" class="err" style="margin-top:4px;">{% if debug_info and debug_info.error and mode=='custom' and not recs %}{{ debug_info.error }}{% endif %}</div>
            <button class="primary-cta" type="submit">Get Recommendations</button>
        </form>

        {% if selection_desc %}
        <div style="text-align:center;margin:20px auto 10px auto;padding:0 20px;">
            <div style="color:var(--accent);font-size:1.4em;font-weight:bold;text-shadow:1px 1px 4px #000;">
                <span style="color:#ddd08a;">{{ selection_desc }}</span>
            </div>
        </div>
        {% endif %}

        {% if recs %}
            {% if selected_user %}
                {% set user_name = (selected_user.friendly_name or selected_user.username) %}
                {% if user_name %}<div class="username">Recommendations for {{ user_name }}</div>{% endif %}
            {% endif %}
            {% if recs.show_posters and recs.show_posters[0].href %}
                        <div class="note">Tap a poster to open the title in Overseerr. Recommendations are (probably) unwatched for your account.</div>
            {% endif %}
            {# Movies first - limit to 10 total #}
            {% set movie_available = recs.movie_posters[:12] if recs.movie_posters else [] %}
            {% set movie_unavailable = recs.movie_posters_unavailable[:(12 - movie_available|length)] if recs.movie_posters_unavailable and movie_available|length < 12 else [] %}
            
            {% if movie_available %}
                <div class="section" aria-label="Recommended movies posters">
                    <h3>Movies on Plex</h3>
                    <div class="grid">
                        {% for p in movie_available %}
                            <div class="card" title="{{ p.title }}">
                                {% if p.href %}<a href="{{ p.href }}" target="_blank" rel="noopener noreferrer" style="color:inherit;text-decoration:none;display:block;">{% endif %}
                                <img src="{{ p.url }}" alt="{{ p.title }} poster" />
                                <div class="t">{{ p.title }}</div>
                                {% if recs.ai_movie_years and recs.ai_movie_years.get(p.title) %}<div class="y">{{ recs.ai_movie_years.get(p.title) }}</div>{% endif %}
                                {% if p.href %}</a>{% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
            {% if movie_unavailable %}
                <div class="section alt" aria-label="Unavailable movies posters">
                    <h3>Movies not on Plex... yet</h3>
                    <div class="grid">
                        {% for p in movie_unavailable %}
                            <div class="card" title="{{ p.title }}">
                                {% if p.href %}<a href="{{ p.href }}" target="_blank" rel="noopener noreferrer" style="color:inherit;text-decoration:none;display:block;">{% endif %}
                                <img src="{{ p.url }}" alt="{{ p.title }} poster" />
                                <div class="t">{{ p.title }}</div>
                                {% if recs.ai_movie_years and recs.ai_movie_years.get(p.title) %}<div class="y">{{ recs.ai_movie_years.get(p.title) }}</div>{% endif %}
                                {% if p.href %}</a>{% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            {# Shows after movies #}
            {# Shows second - limit to 10 total #}
            {% set show_available = recs.show_posters[:12] if recs.show_posters else [] %}
            {% set show_unavailable = recs.show_posters_unavailable[:(12 - show_available|length)] if recs.show_posters_unavailable and show_available|length < 12 else [] %}
            
            {% if show_available %}
                <div class="section" aria-label="Recommended shows posters">
                    <h3>Shows on Plex</h3>
                    <div class="grid">
                        {% for p in show_available %}
                            <div class="card" title="{{ p.title }}">
                                {% if p.href %}<a href="{{ p.href }}" target="_blank" rel="noopener noreferrer" style="color:inherit;text-decoration:none;display:block;">{% endif %}
                                <img src="{{ p.url }}" alt="{{ p.title }} poster" />
                                <div class="t">{{ p.title }}</div>
                                {% if recs.ai_show_years and recs.ai_show_years.get(p.title) %}<div class="y">{{ recs.ai_show_years.get(p.title) }}</div>{% endif %}
                                {% if p.href %}</a>{% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
            {% if show_unavailable %}
                <div class="section alt" aria-label="Unavailable shows posters">
                    <h3>Shows not on Plex... yet</h3>
                    <div class="grid">
                        {% for p in show_unavailable %}
                            <div class="card" title="{{ p.title }}">
                                {% if p.href %}<a href="{{ p.href }}" target="_blank" rel="noopener noreferrer" style="color:inherit;text-decoration:none;display:block;">{% endif %}
                                <img src="{{ p.url }}" alt="{{ p.title }} poster" />
                                <div class="t">{{ p.title }}</div>
                                {% if recs.ai_show_years and recs.ai_show_years.get(p.title) %}<div class="y">{{ recs.ai_show_years.get(p.title) }}</div>{% endif %}
                                {% if p.href %}</a>{% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            {# Show AI Categories only for history mode #}
            {% if recs.ai_categories and mode != 'custom' %}
                <div class="section">
                    {% set user_name = (selected_user.friendly_name or selected_user.username) if selected_user else None %}
                    <h3>{{ (user_name ~ "'s") if user_name else 'AI' }} Categories</h3>
                    <div class="ticker" aria-label="AI Categories ticker">
                        <div class="ticker__content">
                            {% for it in recs.ai_categories %}<span class="ticker__item">{{ it }}</span>{% endfor %}
                            {% for it in recs.ai_categories %}<span class="ticker__item">{{ it }}</span>{% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}

            <div class="toggle"><a href="#" id="toggle-details">show table details</a></div>
            <div class="tbl-wrap" id="details-container">
                <table>
                    <tr>
                        <th>Type</th>
                        <th>Recommendations (Available, Unwatched)</th>
                        <th>AI Recs Not In Library</th>
                        <th>AI Recommendations</th>
                        <th>Top 3 Watched</th>
                        <th>Most Watched</th>
                        <th>Recently Watched</th>
                    </tr>
                    <tr>
                        <td>Movies</td>
                        <td>{% if recs.movies %}<ul>{% for it in recs.movies[:9] %}<li>{{ it }}</li>{% endfor %}</ul>{% else %}-{% endif %}</td>
                        <td>{% if recs.ai_movies_unavailable %}<ul>{% for it in recs.ai_movies_unavailable %}<li>{{ it }}</li>{% endfor %}</ul>{% else %}-{% endif %}</td>
                        <td>{% set movie_top = recs.ai_movies_titles if recs.ai_movies_titles else recs.ai_movies %}{% if movie_top %}<ul>{% for it in movie_top %}<li>{{ it }}</li>{% endfor %}</ul>{% else %}-{% endif %}</td>
                        <td>{% if recs.top_movies %}<ul>{% for it in recs.top_movies %}<li>{{ it }}</li>{% endfor %}</ul>{% else %}-{% endif %}</td>
                        <td>{% if recs.top_movies %}{{ recs.top_movies[0] }}{% else %}-{% endif %}</td>
                        <td>{% if recs.debug and recs.debug.recent_movies %}<ul>{% for it in recs.debug.recent_movies %}<li>{{ it }}</li>{% endfor %}</ul>{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                        <td>Shows</td>
                        <td>{% if recs.shows %}<ul>{% for it in recs.shows[:9] %}<li>{{ it }}</li>{% endfor %}</ul>{% else %}-{% endif %}</td>
                        <td>{% if recs.ai_shows_unavailable %}<ul>{% for it in recs.ai_shows_unavailable %}<li>{{ it }}</li>{% endfor %}</ul>{% else %}-{% endif %}</td>
                        <td>{% set show_top = recs.ai_shows_titles if recs.ai_shows_titles else recs.ai_shows %}{% if show_top %}<ul>{% for it in show_top %}<li>{{ it }}</li>{% endfor %}</ul>{% else %}-{% endif %}</td>
                        <td>{% if recs.top_shows %}<ul>{% for it in recs.top_shows %}<li>{{ it }}</li>{% endfor %}</ul>{% else %}-{% endif %}</td>
                        <td>{% if recs.top_shows %}{{ recs.top_shows[0] }}{% else %}-{% endif %}</td>
                        <td>{% if recs.debug and recs.debug.recent_shows %}<ul>{% for it in recs.debug.recent_shows %}<li>{{ it }}</li>{% endfor %}</ul>{% else %}-{% endif %}</td>
                    </tr>
                </table>
            </div>
        {% endif %}
    </div>

    <script>
        // Detect if library is building from server-provided DOM state (present on main template)
        // Here we keep a simple overlay behavior for submit
        function randomizeLoading() {
            var img = document.getElementById('loading-gif');
            if (!img) return;
            var gifs = ['/static/load.gif', '/static/load2.gif', '/static/load3.gif'];
            // Preload & pick a working gif; fall back gracefully.
            var shuffled = gifs.slice().sort(function(){ return Math.random()-0.5; });
            var picked = null;
            var tryNext = function(){
                if(!shuffled.length){ picked = gifs[0]; img.src = picked; return; }
                var candidate = shuffled.shift();
                var test = new Image();
                test.onload = function(){ picked = candidate; img.src = picked; };
                test.onerror = function(){ tryNext(); };
                test.src = candidate + '?v=' + Date.now(); // cache-bust to avoid stale/broken cache
            };
            tryNext();
            // Safety fallback if none load within 1500ms
            setTimeout(function(){ if(!picked){ img.src = '/static/load.gif'; } }, 1500);
            var phrases = [
                "Consulting Zoltarr's crystal ball...",
                "Checking out blockbuster shelves...",
                "Summoning Zoltarr's ancient wisdom...",
                "Peeking behind the velvet curtain...",
                "Looking for hidden gems...",
                "Polishing the magic lamp lol...",
                "Reading fortunes in your watch history...",
                "Asking the oracle (please hold)...",
                "Shuffling fate's deck...",
                "Zoltarr and chill?",
                "Whoops, not that movie...",
                "Uhhh... I mean, how about this one?",
                "Don't yell at the developer",
                "Fine tuning suggestions...",
                "Checking spark plugs...",
                "Reticulating Splines...",
                "Optimizing the flux capacitor...",
                "Spooling up turbines..."
            ];
            var el = document.getElementById('loading-text');
            if (el) el.textContent = phrases[Math.floor(Math.random() * phrases.length)];
        }
        window.addEventListener('load', function(){ var o = document.getElementById('loading-overlay'); if (o) o.style.display = 'none'; });
        function toggleCustomMobile(){
            var history = document.getElementById('m-history');
            var show = !(history && history.checked);
            ['decade-wrap','genre-wrap','mood-wrap'].forEach(function(id){ var el=document.getElementById(id); if(el){ el.style.display = show? 'block':'none'; }});
        }
        function handleMoodSelectionMobile(){
            var moodSel = document.getElementById('mood');
            if(!moodSel) return;
            var hasMood = moodSel.value && moodSel.value !== '';
            // Hide decade and genre when mood is selected, per Option A requirement
            ['decade-wrap','genre-wrap'].forEach(function(id){ 
                var el=document.getElementById(id); 
                if(el){ el.style.display = hasMood ? 'none':'block'; }
            });
            // Clear values when hidden
            if(hasMood){
                var decadeSel=document.getElementById('decade'); if(decadeSel) decadeSel.value='';
                var genreSel=document.getElementById('genre'); if(genreSel) genreSel.value='';
            }
        }
        // Cookie helpers
        function zSetCookie(name,value,days){ try { var d=new Date(); d.setTime(d.getTime()+ (days*24*60*60*1000)); document.cookie=name+"="+encodeURIComponent(value)+";expires="+d.toUTCString()+";path=/"; } catch(e){} }
        function zGetCookie(name){ try { var n=name+"="; var ca=document.cookie.split(';'); for(var i=0;i<ca.length;i++){ var c=ca[i].trim(); if(c.indexOf(n)==0) return decodeURIComponent(c.substring(n.length,c.length)); } }catch(e){} return ""; }
        function zPopulateFromCookies(){
            var hasRecsFlag = "{{ '1' if recs else '0' }}";
            if(hasRecsFlag==='1') return; // do not repopulate if showing recs
            var u = zGetCookie('z_user_login'); if(u){ var input=document.getElementById('user_login'); if(input && !input.value) input.value=u; }
            var m = zGetCookie('z_mode'); if(m){ var r=document.querySelector('input[name="mode"][value="'+m+'"]'); if(r){ r.checked=true; }}
            var d = zGetCookie('z_decade'); if(d){ var ds=document.getElementById('decade'); if(ds) ds.value=d; }
            var g = zGetCookie('z_genre'); if(g){ var gs=document.getElementById('genre'); if(gs) gs.value=g; }
            var mood = zGetCookie('z_mood'); if(mood){ var ms=document.getElementById('mood'); if(ms) ms.value=mood; }
            toggleCustomMobile();
            handleMoodSelectionMobile();
        }
        function zStoreOnSubmit(){
            var form=document.querySelector('form[method="post"]'); if(!form) return;
            form.addEventListener('submit', function(){
                var user=document.getElementById('user_login'); if(user) zSetCookie('z_user_login', user.value||'', 30);
                var modeVal=(document.querySelector('input[name="mode"]:checked')||{}).value || 'history'; zSetCookie('z_mode', modeVal, 30);
                var d=document.getElementById('decade'); if(d) zSetCookie('z_decade', d.value||'', 30);
                var g=document.getElementById('genre'); if(g) zSetCookie('z_genre', g.value||'', 30);
                var mood=document.getElementById('mood'); if(mood) zSetCookie('z_mood', mood.value||'', 30);
            });
        }
        document.addEventListener('DOMContentLoaded', function() {
            var form = document.querySelector('form[method="post"]');
            if (form) {
                form.addEventListener('submit', function(e) {
                    var modeVal = (document.querySelector('input[name="mode"]:checked')||{}).value;
                    if(modeVal==='custom'){
                        var decadeSel=document.getElementById('decade');
                        var genreSel=document.getElementById('genre');
                        var moodSel=document.getElementById('mood');
                        var noDecade = !decadeSel || !decadeSel.value;
                        var noGenre = !genreSel || !genreSel.value;
                        var noMood = !moodSel || !moodSel.value;
                        if(noDecade && noGenre && noMood){
                            e.preventDefault();
                            var err=document.getElementById('custom-error-mobile');
                            if(err) err.textContent='Select a decade, genre, or mood (or any combination) for Custom mode.';
                            return false;
                        }
                    }
                    randomizeLoading();
                    var overlay = document.getElementById('loading-overlay');
                    if (overlay) overlay.style.display = 'flex';
                });
            }
            var toggle = document.getElementById('toggle-details');
            var details = document.getElementById('details-container');
            if (toggle && details) {
                toggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    var hidden = details.style.display === 'none' || details.style.display === '';
                    details.style.display = hidden ? 'block' : 'none';
                    toggle.textContent = hidden ? 'hide table details' : 'show table details';
                });
            }
            // Initialize from cookies if clean load (no recs)
            zPopulateFromCookies();
            zStoreOnSubmit();
            toggleCustomMobile();
            ['m-history','m-custom'].forEach(function(id){ var el=document.getElementById(id); if(el){ el.addEventListener('change', toggleCustomMobile); }});
            var moodSel=document.getElementById('mood');
            if(moodSel){ moodSel.addEventListener('change', handleMoodSelectionMobile); }
            if("{{ '1' if recs else '0' }}"==='1'){ try { window.history.replaceState({}, document.title, window.location.pathname); } catch(e){} }
        });
    </script>
</body>
</html>
